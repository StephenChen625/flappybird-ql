<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Flappy Bird Q-learning</title>
    <style>
        canvas {
            margin-top: 35px;
            border: 4px solid #555;
            padding: 5px;
            border-radius: 10px;
            background-color: #111;
        }
        
        #qtable-canvas {
            margin-top: 20px;
            border: 2px solid #333;
            background-color: white;
            display: none;
        }
        
        .qtable-controls {
            margin: 10px 0;
        }
        
        .legend {
            margin: 10px 0;
            font-size: 12px;
        }
        
        .legend-item {
            display: inline-block;
            margin: 0 10px;
        }
        
        .legend-color {
            display: inline-block;
            width: 15px;
            height: 15px;
            border: 1px solid #333;
            margin-right: 5px;
            vertical-align: middle;
        }
    </style>
    <link href="https://cdn.bootcss.com/semantic-ui/2.2.10/semantic.min.css" rel="stylesheet">
</head>

<body>
    <div class="ui menu">
        <div class="item header">Flappy Bird Q-learning</div>
        <div class="right menu">
            <a href="https://github.com/Enhuiz/flappybird-ql" class="ui item">
            View on GitHub &nbsp
            <i class="alternate github icon"></i></a>
        </div>
    </div>

    <center>
        <canvas id="cvs" width="288" height="512"></canvas>
        <br>

        <table id="panel" class="ui very basic collapsing table" style="display: none;">
            <tbody>
                <tr>
                    <td>Max Score</td>
                    <td> <span id="mscore-span">0</span></td>
                </tr>
                <tr>
                    <td>Average Score</td>
                    <td> <span id="ascore-span">0</span></td>
                </tr>
                <tr>
                    <td>Round</td>
                    <td> <span id="round-span">0</span></td>
                </tr>
                <tr>
                    <td>Number of Q-learning States</td>
                    <td> <span id="qstate-span">0</span></td>
                </tr>
            </tbody>
        </table>

        <button id="ql-btn" class="ui basic button">Enable Q-learning</button>
        <div class="ui basic icon buttons">
            <button id="dec-fps-btn" class="ui button"><i class="backward icon"></i></button>
            <button id="rst-fps-btn" class="ui button"><i class="undo icon"></i></button>
            <button id="panel-btn" class="ui button"><i class="bar chart icon"></i></button>
            <button id="inc-fps-btn" class="ui button"><i class="forward icon"></i></button>
        </div>
        
        <div class="qtable-controls">
            <button id="qtable-btn" class="ui basic button">Show Q-table Visualization</button>
        </div>
        
        <canvas id="qtable-canvas" width="800" height="500"></canvas>
        
        <div id="qtable-legend" class="legend" style="display: none;">
            <div class="legend-item">
                <span class="legend-color" style="background-color: #0066cc;"></span>
                <span>Âº∫ÁÉàÂª∫ËÆÆ‰∏çË∑≥Ë∑É (Don't Jump)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #888888;"></span>
                <span>Ë∑≥‰∏çË∑≥ÈÉΩÂ∑Æ‰∏çÂ§ö (Neutral)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #cc0000;"></span>
                <span>Âº∫ÁÉàÂª∫ËÆÆË∑≥Ë∑É (Jump!)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #ffffff; border: 1px solid #333;"></span>
                <span>Êú™Êé¢Á¥¢Âå∫Âüü (Unexplored)</span>
            </div>
            <div class="legend-item">
                <span style="font-weight: bold;">üê¶</span>
                <span>Â∞èÈ∏ü‰ΩçÁΩÆ (Bird Position)</span>
            </div>
        </div>

        <br>

    </center>

    <script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
    <script src="res/js/core.js"></script>

    <script>
        var qlBtn = document.getElementById("ql-btn");
        $("#ql-btn").click(function () {
            updateQL.enabled = !updateQL.enabled;
            if (updateQL.enabled) {
                qlBtn.innerText = "Disable Q-learning";
            } else {
                qlBtn.innerText = "Enable Q-learning";
            }
        });

        $("#inc-fps-btn").click(function () {
            gameLoop.timeScale = Math.min(gameLoop.timeScale * 1.2, 6);
        });

        $("#dec-fps-btn").click(function () {
            gameLoop.timeScale = Math.max(gameLoop.timeScale * 0.833, 1 / 6);
        });

        $("#rst-fps-btn").click(function () {
            gameLoop.timeScale = 1;
        });

        var panel = $("#panel");
        $("#panel-btn").click(function () {
            panel.toggle();
        });

        // Q-table visualization controls
        var qtableCanvas = $("#qtable-canvas");
        var qtableLegend = $("#qtable-legend");
        var qtableBtn = $("#qtable-btn");
        var showQTable = false;

        $("#qtable-btn").click(function () {
            showQTable = !showQTable;
            if (showQTable) {
                qtableCanvas.show();
                qtableLegend.show();
                qtableBtn.text("Hide Q-table Visualization");
            } else {
                qtableCanvas.hide();
                qtableLegend.hide();
                qtableBtn.text("Show Q-table Visualization");
            }
        });

        var fpsSpan = $("#fps-span");
        var roundSpan = $("#round-span");
        var maxScoreSpan = $("#mscore-span");
        var averageScoreSpan = $("#ascore-span");
        var qlStateSpan = $("#qstate-span");

        var round = 0;
        var maxScore = 0;
        var averageScore = 0;
        var qlState = 0;

        gameLoop.eachFrame(function (gameState) {
            if (!panel.is(":visible")) return;

            var newRound = gameState.round;
            if (round !== newRound) {
                round = newRound;
                roundSpan.text(round);
            }

            var newMaxScore = gameState.maxScore;
            if (maxScore !== newMaxScore) {
                maxScore = newMaxScore;
                maxScoreSpan.text(maxScore);
            }

            var newAverageScore = (round == 0 ? 0 : gameState.totalScore / round).toFixed(3);
            if (averageScore !== newAverageScore) {
                averageScore = newAverageScore;
                averageScoreSpan.text(averageScore);
            }

            var newQLState = updateQL.Q ? Object.keys(updateQL.Q).length : 0;
            if (qlState !== newQLState) {
                qlState = newQLState;
                qlStateSpan.text(qlState);
            }

            // Update Q-table visualization if enabled
            if (showQTable && updateQL.Q) {
                renderQTableVisualization();
            }
        });

        // Q-table visualization function
        function renderQTableVisualization() {
            var canvas = document.getElementById("qtable-canvas");
            var ctx = canvas.getContext("2d");
            
            // Clear canvas
            ctx.fillStyle = "#f8f8f8";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (!updateQL.Q || Object.keys(updateQL.Q).length === 0) {
                // Draw empty grid with bird position
                drawBirdAndAxes(ctx, canvas);
                return;
            }
            
            // Define grid parameters - Êõ¥Á≤æÁªÜÁöÑÁΩëÊ†º
            var gridWidth = 80;   // Ê∞¥Âπ≥Ê†ºÂ≠êÊï∞ÔºàÁÆ°ÈÅì‰ΩçÁΩÆÔºâ
            var gridHeight = 50;  // ÂûÇÁõ¥Ê†ºÂ≠êÊï∞ÔºàÂûÇÁõ¥Ë∑ùÁ¶ªÔºâ
            var cellWidth = canvas.width / gridWidth;
            var cellHeight = canvas.height / gridHeight;
            
            // ÊâæÂà∞Áä∂ÊÄÅÁ©∫Èó¥ÁöÑËåÉÂõ¥Êù•‰ºòÂåñÊò†Â∞Ñ
            var xStates = [], yStates = [];
            Object.keys(updateQL.Q).forEach(function(state) {
                var parts = state.split(',');
                xStates.push(parseInt(parts[0]));
                yStates.push(parseInt(parts[1]));
            });
            
            var xMin = Math.min(...xStates) - 2;
            var xMax = Math.max(...xStates) + 2;
            var yMin = Math.min(...yStates) - 2;
            var yMax = Math.max(...yStates) + 2;
            
            // Process each state in Q-table
            Object.keys(updateQL.Q).forEach(function(stateStr) {
                var stateParts = stateStr.split(',');
                var xState = parseInt(stateParts[0]);  // ÁÆ°ÈÅì‰ΩçÁΩÆÁä∂ÊÄÅ
                var yState = parseInt(stateParts[1]);  // ÂûÇÁõ¥Ë∑ùÁ¶ªÁä∂ÊÄÅ
                
                // Êò†Â∞ÑÂà∞ÁîªÂ∏ÉÂùêÊ†á - ËÆ©Â∞èÈ∏üÂú®‰∏≠ÂøÉÂÅèÂ∑¶ÁöÑ‰ΩçÁΩÆ
                var birdGridX = 20;  // Â∞èÈ∏üÂú®ÁΩëÊ†º‰∏≠ÁöÑx‰ΩçÁΩÆ
                var birdGridY = 25;  // Â∞èÈ∏üÂú®ÁΩëÊ†º‰∏≠ÁöÑy‰ΩçÁΩÆ
                
                // ËÆ°ÁÆóÁõ∏ÂØπ‰∫éÂ∞èÈ∏üÁöÑ‰ΩçÁΩÆ
                var relativeX = xState - xMin;
                var relativeY = yState - yMin;
                
                var gridX = Math.min(Math.max(birdGridX + relativeX, 0), gridWidth - 1);
                var gridY = Math.min(Math.max(birdGridY - relativeY, 0), gridHeight - 1);
                
                // ËÆ°ÁÆóÂÜ≥Á≠ñÂÄæÂêëÔºöQ(jump) - Q(stay)
                var jumpQ = updateQL.Q[stateStr][1];    // Ë∑≥Ë∑ÉÁöÑQÂÄº
                var stayQ = updateQL.Q[stateStr][0];    // ‰∏çË∑≥Ë∑ÉÁöÑQÂÄº
                var decisionValue = jumpQ - stayQ;      // Ê≠£ÂÄº=Â∫îËØ•Ë∑≥Ë∑ÉÔºåË¥üÂÄº=‰∏çÂ∫îËØ•Ë∑≥Ë∑É
                
                // Ê†πÊçÆÂÜ≥Á≠ñÂÄæÂêëÁ°ÆÂÆöÈ¢úËâ≤
                var color = getDecisionColor(decisionValue);
                
                // Draw cell
                ctx.fillStyle = color;
                ctx.fillRect(
                    gridX * cellWidth, 
                    gridY * cellHeight, 
                    cellWidth, 
                    cellHeight
                );
                
                // Draw subtle border
                ctx.strokeStyle = "#ddd";
                ctx.lineWidth = 0.3;
                ctx.strokeRect(
                    gridX * cellWidth, 
                    gridY * cellHeight, 
                    cellWidth, 
                    cellHeight
                );
            });
            
            // ÁªòÂà∂Â∞èÈ∏üÂíåÂùêÊ†áËΩ¥
            drawBirdAndAxes(ctx, canvas);
        }
        
        function drawBirdAndAxes(ctx, canvas) {
            var gridWidth = 80;
            var gridHeight = 50;
            var cellWidth = canvas.width / gridWidth;
            var cellHeight = canvas.height / gridHeight;
            
            // Â∞èÈ∏üÁöÑ‰ΩçÁΩÆÔºàÁΩëÊ†ºÂùêÊ†áÔºâ
            var birdGridX = 20;
            var birdGridY = 25;
            var birdX = birdGridX * cellWidth + cellWidth/2;
            var birdY = birdGridY * cellHeight + cellHeight/2;
            
            // ÁîªÂ∞èÈ∏ü
            ctx.fillStyle = "#FFD700";
            ctx.strokeStyle = "#FF8C00";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(birdX, birdY, 8, 0, 2 * Math.PI);
            ctx.fill();
            ctx.stroke();
            
            // ÁîªÂ∞èÈ∏üÁöÑÁúºÁùõ
            ctx.fillStyle = "black";
            ctx.beginPath();
            ctx.arc(birdX + 3, birdY - 2, 2, 0, 2 * Math.PI);
            ctx.fill();
            
            // ÁîªÂèÇËÄÉÁ∫øÔºàÂçÅÂ≠óÁ∫øÔºâ
            ctx.strokeStyle = "#666";
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            
            // ÂûÇÁõ¥ÂèÇËÄÉÁ∫ø
            ctx.beginPath();
            ctx.moveTo(birdX, 0);
            ctx.lineTo(birdX, canvas.height);
            ctx.stroke();
            
            // Ê∞¥Âπ≥ÂèÇËÄÉÁ∫ø
            ctx.beginPath();
            ctx.moveTo(0, birdY);
            ctx.lineTo(canvas.width, birdY);
            ctx.stroke();
            
            ctx.setLineDash([]);
            
            // ÂùêÊ†áËΩ¥Ê†áÁ≠æ
            ctx.fillStyle = "black";
            ctx.font = "bold 14px Arial";
            ctx.fillText("üê¶ Bird", birdX - 20, birdY - 15);
            
            ctx.font = "12px Arial";
            ctx.fillText("ÁÆ°ÈÅìÊ∞¥Âπ≥Ë∑ùÁ¶ª ‚Üí", canvas.width - 120, canvas.height - 10);
            
            ctx.save();
            ctx.translate(15, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText("ÁÆ°ÈÅìÂûÇÁõ¥Ë∑ùÁ¶ª ‚Üë", 0, 0);
            ctx.restore();
            
            // Ê∑ªÂä†ËØ¥ÊòéÊñáÂ≠ó
            ctx.font = "10px Arial";
            ctx.fillStyle = "#666";
            ctx.fillText("Âè≥‰∏äËßíÔºöÁÆ°ÈÅìÂú®Â∞èÈ∏üÂâçÊñπ‰∏î‰∏äÊñπ", canvas.width - 150, 20);
            ctx.fillText("Âè≥‰∏ãËßíÔºöÁÆ°ÈÅìÂú®Â∞èÈ∏üÂâçÊñπ‰∏î‰∏ãÊñπ", canvas.width - 150, 35);
        }
        
        function getDecisionColor(decisionValue) {
            // decisionValue = Q(jump) - Q(stay)
            // Ê≠£ÂÄºË∂äÂ§ß = Ë∂äÂ∫îËØ•Ë∑≥Ë∑É = Ë∂äÁ∫¢
            // Ë¥üÂÄºË∂äÂ§ß = Ë∂ä‰∏çÂ∫îËØ•Ë∑≥Ë∑É = Ë∂äËìù
            // Êé•Ëøë0 = Êó†ÊâÄË∞ì = ÁÅ∞Ëâ≤
            
            var maxIntensity = 20; // ÂΩìÂ∑ÆÂÄºË∂ÖËøáËøô‰∏™ÂÄºÊó∂ÔºåÈ¢úËâ≤ËææÂà∞ÊúÄÊ∑±
            var normalizedValue = Math.max(-maxIntensity, Math.min(maxIntensity, decisionValue)) / maxIntensity;
            
            if (normalizedValue > 0.1) {
                // Âª∫ËÆÆË∑≥Ë∑É - Á∫¢Ëâ≤Á≥ª
                var intensity = Math.floor(255 * normalizedValue);
                var green = Math.floor(100 * (1 - normalizedValue));
                var blue = Math.floor(100 * (1 - normalizedValue));
                return `rgb(${intensity}, ${green}, ${blue})`;
            } else if (normalizedValue < -0.1) {
                // Âª∫ËÆÆ‰∏çË∑≥Ë∑É - ËìùËâ≤Á≥ª
                var intensity = Math.floor(255 * Math.abs(normalizedValue));
                var red = Math.floor(100 * (1 - Math.abs(normalizedValue)));
                var green = Math.floor(150 * (1 - Math.abs(normalizedValue)));
                return `rgb(${red}, ${green}, ${intensity})`;
            } else {
                // ‰∏≠ÊÄßÂÜ≥Á≠ñ - ÁÅ∞Ëâ≤
                var grayLevel = 180;
                return `rgb(${grayLevel}, ${grayLevel}, ${grayLevel})`;
            }
        }

        gameLoop.start();
    </script>
</body>

</html>
